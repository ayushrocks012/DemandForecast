'@Folder("Classes")
Option Explicit

'================================================================================================
' Class:       cCalculationEngine
' Purpose:     Encapsulates the core forecast calculation logic. This class is configured
'              with the names of the relevant business dimensions and executes the
'              forecast formula.
' Version:     2.1
' Author:      Ayush Goyal
' Date:        22-Aug-2025
'
' Change Log:
' V2.1:        - REFACTOR: Removed unused dimension properties (m_TotalLevelDim, etc.)
'                and their corresponding Property Let accessors to resolve Rubberduck warnings.
'                The class relies on direct property access from the cForecastItem object.
' V2.0:        - REFACTOR: Integrated the "Customer" dimension into the core calculation logic.
'              - REFACTOR: The Execute method now requires a customer name.
'              - REFACTOR: All internal key-building functions updated to include the customer,
'                ensuring lookups are performed at the correct granularity.
' V1.3:        - PERFORMANCE: Replaced cDimensionKey with direct string concatenation.
'================================================================================================

' --- Private Member Variables ---
Private m_demandDataArray As Variant
Private m_demandMonthsCol As Long

'================================================================================================
'--- PUBLIC INITIALIZATION & EXECUTION ---
'================================================================================================

Public Sub Init(ByVal DemandDataArray As Variant, ByVal demandMonthsCol As Long)
    m_demandDataArray = DemandDataArray
    m_demandMonthsCol = demandMonthsCol
End Sub

Public Sub Execute(ByVal item As cForecastItem, _
                   ByVal strCustomer As String, _
                   ByVal strKeyFigure As String, _
                   ByVal histCache As Object, _
                   ByVal DemandCache As Object)

    Dim histSubTierSum As Double, histTierSum As Double
    
    ' --- Get historical sums from the cache using customer-specific keys ---
    histTierSum = GetValueFromCache(histCache, BuildTotalLevelKey(item, strCustomer, strKeyFigure))
    
    ' --- Only proceed if the overall tier has a sales history for this customer ---
    If histTierSum > 0 Then
        histSubTierSum = GetValueFromCache(histCache, BuildShareLevelKey(item, strCustomer, strKeyFigure))
        
        Dim monthIndex As Long
        For monthIndex = 1 To UBound(m_demandDataArray, 2) - m_demandMonthsCol + 1
            Dim forecastMonth As Date: forecastMonth = m_demandDataArray(1, m_demandMonthsCol + monthIndex - 1)
            Dim demandTierValue As Double
            
            ' --- Get the tier's demand value from the cache for this customer ---
            demandTierValue = GetValueFromCache(DemandCache, BuildDemandKey(item, strCustomer, strKeyFigure, forecastMonth))
            
            ' --- CORE FORECAST LOGIC (now customer-specific) ---
            Dim productShareOfTier As Double
            If histTierSum <> 0 Then productShareOfTier = histSubTierSum / histTierSum

            Dim baseForecast As Double
            baseForecast = productShareOfTier * demandTierValue
            
            ' --- Store the forecast value with a key that includes the customer ---
            item.ForecastValues.Add strCustomer & "|" & strKeyFigure & "|" & forecastMonth, baseForecast
        Next monthIndex
    Else
        ' --- If tier has no history for this customer, all forecasts are zero ---
        Dim i As Long
        For i = 1 To UBound(m_demandDataArray, 2) - m_demandMonthsCol + 1
            Dim fMonth As Date: fMonth = m_demandDataArray(1, m_demandMonthsCol + i - 1)
            item.ForecastValues.Add strCustomer & "|" & strKeyFigure & "|" & fMonth, 0
        Next i
    End If
End Sub

'================================================================================================
'--- PRIVATE HELPER METHODS (OPTIMIZED) ---
'================================================================================================

Private Function BuildTotalLevelKey(ByVal item As cForecastItem, ByVal strCustomer As String, ByVal strKeyFigure As String) As String
    ' UPDATED: Key now includes Customer.
    ' Sorted alphabetically: "Affiliate", "Customer", "ForecastTier", "KeyFigure"
    BuildTotalLevelKey = item.Affiliate & "|" & _
                         strCustomer & "|" & _
                         item.ForecastTier & "|" & _
                         strKeyFigure
End Function

Private Function BuildShareLevelKey(ByVal item As cForecastItem, ByVal strCustomer As String, ByVal strKeyFigure As String) As String
    ' UPDATED: Key now includes Customer.
    ' Sorted alphabetically: "Affiliate", "Customer", "ForecastSubTier", "ForecastTier", "KeyFigure"
    BuildShareLevelKey = item.Affiliate & "|" & _
                         strCustomer & "|" & _
                         item.ForecastSubTier & "|" & _
                         item.ForecastTier & "|" & _
                         strKeyFigure
End Function

Private Function BuildDemandKey(ByVal item As cForecastItem, ByVal strCustomer As String, ByVal strKeyFigure As String, ByVal dteMonth As Date) As String
    ' UPDATED: Key now includes Customer.
    ' Sorted alphabetically: "Affiliate", "Customer", "ForecastTier", "KeyFigure", "Month"
    BuildDemandKey = item.Affiliate & "|" & _
                     strCustomer & "|" & _
                     item.ForecastTier & "|" & _
                     strKeyFigure & "|" & _
                     dteMonth
End Function

Private Function GetValueFromCache(ByVal cache As Object, ByVal cacheKey As String) As Double
    If cache.Exists(cacheKey) Then
        GetValueFromCache = cache.item(cacheKey)
    Else
        GetValueFromCache = 0
    End If
End Function
