'@Folder("Classes")
Option Explicit

'================================================================================================
' Class:       cForecastItem
' Purpose:     Represents a single, generic item to be forecasted. This class is
'              primarily a data container for an item's properties and its
'              calculated forecast values.
' Version:     3.2
' Author:      Ayush Goyal
' Date:        22-Aug-2025
'
' Change Log:
' V3.2:        - BUGFIX: Removed the unused m_Dimensions variable which was of type
'                cDimensionKey, a class that has been made redundant and removed.
'                This resolves the "User-defined type not defined" compile error.
' V3.1:        - REFACTOR: Replaced all hard-coded data field strings with constants.
' V3.0:        - REFACTOR: Updated logic to use new explicit product statuses.
'================================================================================================

' --- Private Member Variables ---
Private m_Properties As Object
Private m_ForecastValues As Object

' --- Constants ---
Private Const DEFAULT_PHASE_OUT_PCT As Double = 1#

'================================================================================================
'--- PUBLIC WRAPPER PROPERTIES (For Reporting and Business Logic) ---
'================================================================================================

'@Ignore UnusedMember
Public Property Get Affiliate() As String: Affiliate = GetProp(FIELD_AFFILIATE): End Property
'@Ignore UnusedMember
Public Property Get ForecastTier() As String: ForecastTier = GetProp(FIELD_TIER): End Property
'@Ignore UnusedMember
Public Property Get ForecastSubTier() As String: ForecastSubTier = GetProp(FIELD_SUBTIER): End Property
'@Ignore UnusedMember
Public Property Get LocalItemNbr() As String: LocalItemNbr = GetProp(FIELD_LOCALITEMNBR): End Property
'@Ignore UnusedMember
Public Property Get Description() As String: Description = GetProp(FIELD_DESCRIPTION): End Property
'@Ignore UnusedMember
Public Property Get ISD() As String: ISD = GetProp(FIELD_ISD): End Property
'@Ignore UnusedMember
Public Property Get Status() As ProductStatus: Status = GetProp(FIELD_STATUS): End Property

Public Property Get PhaseOutDate() As Variant
    Dim val As Variant
    val = GetProp(FIELD_PHASEOUTDATE)
    If IsDate(val) And val > 0 Then
        PhaseOutDate = val
    Else
        PhaseOutDate = Empty
    End If
End Property

'@Ignore UnusedMember
Public Property Get PhaseOutPercent() As Double: PhaseOutPercent = GetProp(FIELD_PHASEOUTPERCENT): End Property
'@Ignore UnusedMember
Public Property Get SupersededByProductID() As String: SupersededByProductID = GetProp(FIELD_SUPERSEDEDBY): End Property

Public Property Get IsPhasingOut() As Boolean
    IsPhasingOut = (Me.Status = psPhaseOut Or Me.Status = psDiscontinued)
End Property

'@Ignore UnusedMember
Public Property Get IsPhasingIn() As Boolean: IsPhasingIn = GetProp("IsPhasingIn", False): End Property
'@Ignore UnusedMember
Public Property Get PhaseInDate() As Date: PhaseInDate = GetProp("PhaseInDate"): End Property
'@Ignore UnusedMember
Public Property Get PhaseInPercent() As Double: PhaseInPercent = GetProp("PhaseInPercent"): End Property

Public Property Get ForecastValues() As Object: Set ForecastValues = m_ForecastValues: End Property
Public Property Set ForecastValues(ByVal Value As Object): Set m_ForecastValues = Value: End Property

'@Ignore UnusedMember
Public Property Get StatusString() As String
    StatusString = GetStatusString(Me.Status)
End Property

'================================================================================================
'--- INITIALIZATION AND LIFECYCLE LOGIC ---
'================================================================================================

Private Sub Class_Initialize()
    Set m_Properties = CreateObject("Scripting.Dictionary")
    m_Properties.CompareMode = vbTextCompare
    Set m_ForecastValues = CreateObject("Scripting.Dictionary")
End Sub

Public Sub Init(ByVal ds As cDataSource, ByVal arrDataSource As Variant, ByVal lngRow As Long)
    AddProp FIELD_AFFILIATE, arrDataSource(lngRow, ds.GetCol(FIELD_AFFILIATE))
    AddProp FIELD_TIER, arrDataSource(lngRow, ds.GetCol(FIELD_TIER))
    AddProp FIELD_SUBTIER, arrDataSource(lngRow, ds.GetCol(FIELD_SUBTIER))
    AddProp FIELD_LOCALITEMNBR, arrDataSource(lngRow, ds.GetCol(FIELD_LOCALITEMNBR))
    AddProp FIELD_DESCRIPTION, arrDataSource(lngRow, ds.GetCol(FIELD_DESCRIPTION))
    AddProp FIELD_ISD, arrDataSource(lngRow, ds.GetCol(FIELD_ISD))
    AddProp FIELD_STATUS, GetStatusEnum(arrDataSource(lngRow, ds.GetCol(FIELD_STATUS)))
    AddProp FIELD_SUPERSEDEDBY, arrDataSource(lngRow, ds.GetCol(FIELD_SUPERSEDEDBY))
    
    HandlePhaseOutInit ds, arrDataSource, lngRow
End Sub

Public Function GetForecastMultiplier(ByVal dteForecastDate As Date) As Double
    GetForecastMultiplier = 1 ' Default to full forecast

    If Me.IsPhasingIn And Me.PhaseInDate > 0 Then
        If FirstDayOfMonth(dteForecastDate) < FirstDayOfMonth(Me.PhaseInDate) Then
            GetForecastMultiplier = 0
            Exit Function
        ElseIf FirstDayOfMonth(dteForecastDate) = FirstDayOfMonth(Me.PhaseInDate) Then
            GetForecastMultiplier = Me.PhaseInPercent
            Exit Function
        End If
    End If

    If Me.IsPhasingOut And Me.PhaseOutDate > 0 Then
        If FirstDayOfMonth(dteForecastDate) > FirstDayOfMonth(Me.PhaseOutDate) Then
            GetForecastMultiplier = 0
        ElseIf FirstDayOfMonth(dteForecastDate) = FirstDayOfMonth(Me.PhaseOutDate) Then
            GetForecastMultiplier = Me.PhaseOutPercent
        End If
    End If
End Function

Public Sub MarkAsPhasingIn(ByVal dteDate As Date, ByVal dblPercent As Double)
    AddProp "IsPhasingIn", True
    AddProp "PhaseInDate", dteDate
    AddProp "PhaseInPercent", dblPercent
End Sub

Public Function DebugSummary() As String
    DebugSummary = Me.Affiliate & " | " & Me.LocalItemNbr & " | " & GetStatusString(Me.Status)
End Function

'================================================================================================
'--- PRIVATE HELPER METHODS ---
'================================================================================================

Public Sub AddProp(ByVal Key As String, ByVal Value As Variant)
    Dim cleanValue As Variant
    If IsObject(Value) Then
        Set cleanValue = Value
    ElseIf IsDate(Value) Then
        cleanValue = CDate(Value)
    Else
        cleanValue = Trim$(CStr(Value))
    End If

    If m_Properties.Exists(Key) Then
        m_Properties.item(Key) = cleanValue
    Else
        m_Properties.Add Key, cleanValue
    End If
End Sub

Private Function GetProp(ByVal Key As String, Optional ByVal DefaultValue As Variant) As Variant
    If m_Properties.Exists(Key) Then
        GetProp = m_Properties.item(Key)
    Else
        If IsMissing(DefaultValue) Then
            GetProp = Empty
        Else
            GetProp = DefaultValue
        End If
    End If
End Function

Private Sub HandlePhaseOutInit(ByVal ds As cDataSource, ByVal arrDataSource As Variant, ByVal lngRow As Long)
    Dim varPhaseOutPct As Variant: varPhaseOutPct = arrDataSource(lngRow, ds.GetCol(FIELD_PHASEOUTPERCENT))
    If IsNumeric(varPhaseOutPct) And varPhaseOutPct >= 0 And varPhaseOutPct <= 1 Then
        AddProp FIELD_PHASEOUTPERCENT, CDbl(varPhaseOutPct)
    Else
        AddProp FIELD_PHASEOUTPERCENT, DEFAULT_PHASE_OUT_PCT
    End If

    If Me.Status = psPhaseOut Or Me.Status = psDiscontinued Then
        If IsDate(arrDataSource(lngRow, ds.GetCol(FIELD_PHASEOUTDATE))) Then
            AddProp FIELD_PHASEOUTDATE, CDate(arrDataSource(lngRow, ds.GetCol(FIELD_PHASEOUTDATE)))
        End If
    End If
End Sub

Private Function FirstDayOfMonth(ByVal d As Date) As Date
    FirstDayOfMonth = DateSerial(Year(d), Month(d), 1)
End Function
