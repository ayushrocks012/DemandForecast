'@Folder("Configuration")
Option Explicit

'================================================================================================
' Module:      mConfiguration
' Purpose:     This module defines all global constants and utility functions for the project.
'              It acts as a central control panel for sheet names, column positions,
'              and business logic enumerations.
' Version:     41.0
' Author:      Ayush Goyal
' Date:        22-Aug-2025
'
' Change Log:
' V41.0:       - REFACTOR: Replaced all hard-coded data field strings with public constants
'                (e.g., "Affiliate" -> FIELD_AFFILIATE) for improved maintainability
'                and to prevent typo-related errors.
' V40.0:       - REFACTOR: Added "Customer" dimension and updated status logic.
'================================================================================================

' --- DEBUGGING & LOGGING FLAGS ---
Public Const DEBUG_MODE As Boolean = False 'TRUE: Prevents file saving, adds more logs. FALSE: Normal operation.

' --- SHEET NAME CONSTANTS ---
Public Const SHEET_STATUS As String = "Product Status"
Public Const SHEET_DEMAND As String = "Demand Forecast"
Public Const SHEET_HISTORY As String = "Historical Sales"
Public Const SHEET_LOG As String = "Log"

' --- DATA FIELD NAME CONSTANTS ---
Public Const FIELD_AFFILIATE As String = "Affiliate"
Public Const FIELD_CUSTOMER As String = "Customer"
Public Const FIELD_TIER As String = "Tier"
Public Const FIELD_SUBTIER As String = "SubTier"
Public Const FIELD_LOCALITEMNBR As String = "LocalItemNbr"
Public Const FIELD_DESCRIPTION As String = "Description"
Public Const FIELD_ISD As String = "ISD"
Public Const FIELD_STATUS As String = "Status"
Public Const FIELD_STATUS_STRING As String = "StatusString"
Public Const FIELD_PHASEOUTDATE As String = "PhaseOutDate"
Public Const FIELD_PHASEOUTPERCENT As String = "PhaseOutPercent"
Public Const FIELD_SUPERSEDEDBY As String = "SupersededBy"
Public Const FIELD_KEYFIGURE As String = "KeyFigure"

' --- CALCULATION ENGINE CONFIGURATION ---
Public Const CALC_AFFILIATE_DIM As String = FIELD_AFFILIATE
Public Const CALC_CUSTOMER_DIM As String = FIELD_CUSTOMER
Public Const CALC_TOTAL_LEVEL_DIM As String = "ForecastTier"
Public Const CALC_SHARE_LEVEL_DIM As String = "ForecastSubTier"
Public Const CALC_KEY_FIGURE_DIM As String = FIELD_KEYFIGURE

' --- GLOBAL CONFIGURATION OBJECTS ---
Public g_dsProductStatus As cDataSource
Public g_dsHistory As cDataSource
Public g_dsDemand As cDataSource
Private pTierReportCols As Collection
Private pSummaryReportCols As Collection
Private dictStatusMap As Object

' --- ENUMERATIONS ---
Public Enum ProductStatus
    psNotApplicable = -1 ' Will be ignored during data load
    psUnknown = 0
    psActive = 1
    psDiscontinued = 2
    psPhaseOut = 3
    psPhaseIn = 4
End Enum

Public Enum logType
    ltInfo
    ltWarning
    ltError
    ltFatal
    ltProfile
End Enum

'================================================================================================
'--- GLOBAL INITIALIZATION & UTILITY FUNCTIONS ---
'================================================================================================

Public Sub InitializeAllConfigs(Optional ByVal dummy As Boolean)
    InitializeStatusMap
    InitializeProductStatusSource
    InitializeHistorySource
    InitializeDemandSource
    InitializeTierReportConfig
    InitializeSummaryReportConfig
End Sub

Public Sub CleanupAllConfigs(Optional ByVal dummy As Boolean)
    Set pTierReportCols = Nothing
    Set pSummaryReportCols = Nothing
    Set g_dsProductStatus = Nothing
    Set g_dsHistory = Nothing
    Set g_dsDemand = Nothing
    Set dictStatusMap = Nothing
End Sub

' --- Status Mapping ---
Private Sub InitializeStatusMap()
    Set dictStatusMap = CreateObject("Scripting.Dictionary")
    dictStatusMap.CompareMode = vbTextCompare
    dictStatusMap.Add "ACTIVE", psActive
    dictStatusMap.Add "DISCONTINUED", psDiscontinued
    dictStatusMap.Add "PHASE OUT", psPhaseOut
    dictStatusMap.Add "PHASE IN", psPhaseIn
    dictStatusMap.Add "NOT APPLICABLE", psNotApplicable
End Sub

Public Function GetStatusEnum(ByVal strStatus As String) As ProductStatus
    Dim strKey As String: strKey = UCase$(Trim$(strStatus))
    If dictStatusMap.Exists(strKey) Then
        GetStatusEnum = dictStatusMap.item(strKey)
    Else
        GetStatusEnum = psUnknown
    End If
End Function

Public Function GetStatusString(ByVal enmStatus As ProductStatus) As String
    Select Case enmStatus
        Case psActive: GetStatusString = "Active"
        Case psDiscontinued: GetStatusString = "Discontinued"
        Case psPhaseOut: GetStatusString = "Phase Out"
        Case psPhaseIn: GetStatusString = "Phase In"
        Case psNotApplicable: GetStatusString = "Not Applicable"
        Case Else: GetStatusString = "Unknown"
    End Select
End Function

' --- Report Configuration ---
Public Function GetTierReportCols() As Collection
    Set GetTierReportCols = pTierReportCols
End Function

Public Function GetSummaryReportCols() As Collection
    Set GetSummaryReportCols = pSummaryReportCols
End Function

Private Sub InitializeTierReportConfig()
    Set pTierReportCols = New Collection
    AddReportColumn pTierReportCols, "Key Figures", FIELD_KEYFIGURE, 25, "@"
    AddReportColumn pTierReportCols, "Affiliate", FIELD_AFFILIATE, 10, "@"
    AddReportColumn pTierReportCols, "Customer", FIELD_CUSTOMER, 20, "@"
    AddReportColumn pTierReportCols, "Forecast Tier", "ForecastTier", 30, "@"
    AddReportColumn pTierReportCols, "Forecast Sub-Tier", "ForecastSubTier", 20, "@"
    AddReportColumn pTierReportCols, "Local Item Nbr", FIELD_LOCALITEMNBR, 18, "@"
    AddReportColumn pTierReportCols, "Desc", FIELD_DESCRIPTION, 40, "@"
    AddReportColumn pTierReportCols, "I-S-D", FIELD_ISD, 15, "@"
    AddReportColumn pTierReportCols, "Status", FIELD_STATUS_STRING, 20, "@"
    AddReportColumn pTierReportCols, "Phase Out Month", FIELD_PHASEOUTDATE, 15, "mmm-yy"
End Sub

Private Sub InitializeSummaryReportConfig()
    Set pSummaryReportCols = New Collection
    AddReportColumn pSummaryReportCols, "Affiliate", FIELD_AFFILIATE, 10, "@"
    AddReportColumn pSummaryReportCols, "Customer", FIELD_CUSTOMER, 20, "@"
    AddReportColumn pSummaryReportCols, "Forecast Tier", "ForecastTier", 30, "@"
    AddReportColumn pSummaryReportCols, "Forecast Sub-Tier", "ForecastSubTier", 20, "@"
    AddReportColumn pSummaryReportCols, "Local Item Nbr", FIELD_LOCALITEMNBR, 18, "@"
    AddReportColumn pSummaryReportCols, "Desc", FIELD_DESCRIPTION, 40, "@"
    AddReportColumn pSummaryReportCols, "I-S-D", FIELD_ISD, 15, "@"
    AddReportColumn pSummaryReportCols, "Status", FIELD_STATUS_STRING, 20, "@"
    AddReportColumn pSummaryReportCols, "Phase Out Month", FIELD_PHASEOUTDATE, 15, "mmm-yy"
End Sub

Private Sub AddReportColumn(ByVal colReport As Collection, ByVal header As String, ByVal prop As String, ByVal width As Double, ByVal format As String)
    Dim col As cReportColumn
    Set col = New cReportColumn
    col.HeaderText = header
    col.SourceProperty = prop
    col.ColumnWidth = width
    col.NumberFormat = format
    colReport.Add col
End Sub

' --- Data Source Configuration ---
Private Sub InitializeProductStatusSource()
    Set g_dsProductStatus = New cDataSource
    With g_dsProductStatus
        .sheetName = SHEET_STATUS
        .MapField FIELD_AFFILIATE, 1
        .MapField FIELD_TIER, 2
        .MapField FIELD_SUBTIER, 3
        .MapField FIELD_LOCALITEMNBR, 4
        .MapField FIELD_DESCRIPTION, 5
        .MapField FIELD_ISD, 6
        .MapField FIELD_STATUS, 7
        .MapField FIELD_PHASEOUTDATE, 8
        .MapField FIELD_PHASEOUTPERCENT, 9
        .MapField FIELD_SUPERSEDEDBY, 10
    End With
End Sub

Private Sub InitializeHistorySource()
    Set g_dsHistory = New cDataSource
    With g_dsHistory
        .sheetName = SHEET_HISTORY
        .MapField FIELD_AFFILIATE, 1
        .MapField FIELD_TIER, 2
        .MapField FIELD_SUBTIER, 3
        .MapField FIELD_CUSTOMER, 4
        .MapField FIELD_KEYFIGURE, 5
        .MapField FIELD_LOCALITEMNBR, 6
        .StartOfMonthsCol = 9
    End With
End Sub

Private Sub InitializeDemandSource()
    Set g_dsDemand = New cDataSource
    With g_dsDemand
        .sheetName = SHEET_DEMAND
        .MapField FIELD_AFFILIATE, 1
        .MapField FIELD_CUSTOMER, 2
        .MapField FIELD_KEYFIGURE, 3
        .MapField FIELD_TIER, 4
        .StartOfMonthsCol = 5
    End With
End Sub
